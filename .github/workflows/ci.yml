name: CI

on:
  push:
    branches: [master]
    tags: ['v*']
  pull_request:
    branches: [master]

jobs:
  test-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        ruby: ['3.2', '3.3']
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
      - name: Install system dependencies
        run: brew install sqlite curl
      - name: Install test dependencies
        run: gem install --no-document rspec sqlite3 sqlite3-ffi
      - name: Build and install gem
        run: |
          gem build sqlite_web_vfs.gemspec
          gem install --no-document ./sqlite_web_vfs-*.gem
      - name: Run integration tests
        run: rspec -fd spec/integration

  test-linux:
    runs-on: ubuntu-latest
    container:
      image: amazonlinux:2023
    steps:
      - name: Install system dependencies
        run: |
          dnf -y update
          dnf -y install ruby ruby-devel gcc gcc-c++ clang make \
            sqlite-devel libcurl-devel git tar gzip
      - uses: actions/checkout@v4
      - name: Install Ruby dependencies
        run: gem install --no-document bundler rake rspec sqlite3 sqlite3-ffi
      - name: Build and install gem
        run: |
          gem build sqlite_web_vfs.gemspec
          CXX=g++ CXXFLAGS="-std=gnu++17" \
            gem install --no-document ./sqlite_web_vfs-*.gem || \
            (echo 'Falling back to clang++'; CXX=clang++ CXXFLAGS="-std=gnu++17" \
              gem install --no-document ./sqlite_web_vfs-*.gem)
      - name: Run integration tests
        run: rspec -fd spec/integration

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
      - name: Security audit
        run: bundle exec bundler-audit check --update

  publish:
    needs: [test-macos, test-linux, audit]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      - uses: rubygems/configure-rubygems-credentials@v1.0.0
      - name: Build and push gem
        run: |
          gem build sqlite_web_vfs.gemspec
          gem push sqlite_web_vfs-*.gem
